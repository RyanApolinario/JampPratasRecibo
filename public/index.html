<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Recibos - JAMP Pratas</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #D4AF37;
            --dark-gold: #B8941E;
            --silver: #C0C0C0;
            --dark: #1a1a1a;
            --gray: #2a2a2a;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --border: #e0e0e0;
            --primary-color: #D4AF37;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            color: var(--dark);
            padding: 60px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 100%;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .login-logo p {
            color: #666;
            font-size: 0.9em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .login-box .form-group input {
            background: var(--white);
            color: var(--dark);
        }

        /* Sistema principal: inputs/textarea/select escuros dentro dos cards */
        .card .form-group input,
        .card .form-group textarea,
        .card .form-group select,
        .search-box input {
            background: var(--dark);
            color: var(--white);
            border-color: var(--border);
        }

        /* Placeholder mais suave no tema escuro */
        .card .form-group input::placeholder,
        .card .form-group textarea::placeholder,
        .search-box input::placeholder {
            color: #888;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .login-button {
            background: var(--gold);
            color: var(--dark);
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-button:hover {
            background: var(--dark-gold);
            transform: translateY(-2px);
        }

        .login-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MAIN SYSTEM */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .container.active {
            display: block;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 40px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3em;
            color: var(--gold);
            flex: 1;
        }

        .user-info {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-badge {
            background: var(--gray);
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-badge strong {
            color: var(--gold);
        }

        .admin-badge {
            background: var(--gold);
            color: var(--dark);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .logout-button {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-button:hover {
            background: var(--gold);
            color: var(--dark);
        }

        .tab-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gray);
            padding-bottom: 10px;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #999;
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
        }

        .tab-button:hover {
            color: var(--white);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #tab-usuarios {
            display: none;
        }

        #tab-usuarios.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--gray);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .card h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            color: var(--gold);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gold);
        }

        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--white);
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--white);
            font-weight: normal;
        }

        .radio-group input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .button {
            flex: 1;
            padding: 15px;
            background: var(--gold);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .button:hover {
            background: var(--dark-gold);
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-secondary {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
        }

        .button-secondary:hover {
            background: var(--gold);
            color: var(--dark);
        }

        .search-box {
            margin-bottom: 25px;
        }

        .search-box input {
            width: 100%;
            padding: 15px;
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--white);
            font-size: 1em;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .orders-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .order-item {
            background: var(--dark);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--gold);
        }

        .order-item h3 {
            color: var(--gold);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item p {
            margin: 8px 0;
            color: #ccc;
        }

        .order-item strong {
            color: var(--white);
        }

        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-pago {
            background: #4CAF50;
            color: white;
        }

        .status-metade {
            background: #FF9800;
            color: white;
        }

        .status-pendente {
            background: #f44336;
            color: white;
        }

        .sync-status {
            text-align: center;
            padding: 10px;
            margin-top: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            background: var(--dark);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .receipt-container {
            background: white;
            color: #1a1a1a;
            max-width: 850px;
            width: 100%;
            padding: 60px;
            border-radius: 0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .receipt-header {
            text-align: center;
            padding-bottom: 40px;
            margin-bottom: 40px;
            border-bottom: 3px solid #1a1a1a;
        }

        .receipt-logo {
            width: 280px;
            height: auto;
            margin: 0 auto 30px;
            display: block;
        }

        .receipt-number {
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            color: #666;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .receipt-date {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .receipt-info {
            margin-bottom: 40px;
            background: #f8f8f8;
            padding: 30px;
            border-radius: 8px;
        }

        .receipt-section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #D4AF37;
        }

        .receipt-row {
            display: flex;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            align-items: baseline;
        }

        .receipt-row:last-child {
            border-bottom: none;
        }

        .receipt-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
            max-width: 160px;
            flex-shrink: 0;
        }

        .receipt-value {
            color: #1a1a1a;
            font-size: 1em;
            font-weight: 500;
            word-break: break-word;
            flex: 1;
        }

        .receipt-observations {
            background: #f8f8f8;
            padding: 30px;
            border-radius: 8px;
            min-height: 180px;
            margin: 30px 0;
        }

        .receipt-observations h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a1a1a;
            padding-bottom: 10px;
            border-bottom: 2px solid #D4AF37;
        }

        .receipt-observations-content {
            color: #333;
            line-height: 1.8;
            font-size: 0.95em;
        }

        .receipt-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .receipt-payment {
            background: #f8f8f8;
            padding: 25px;
            border-radius: 8px;
        }

        .receipt-payment h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #1a1a1a;
        }

        .receipt-payment-item {
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .receipt-payment-item:last-child {
            border-bottom: none;
        }

        .receipt-payment-item strong {
            color: #666;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 5px;
        }

        .receipt-payment-item p {
            color: #1a1a1a;
            font-size: 1em;
            font-weight: 500;
        }

        .receipt-total {
            background: #1a1a1a;
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .receipt-total h4 {
            font-size: 0.9em;
            color: #D4AF37;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .receipt-total h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            font-weight: 700;
            color: white;
        }

        .receipt-delivery {
            background: #f8f8f8;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            grid-column: 1 / -1;
        }

        .receipt-delivery-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .receipt-delivery h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            font-weight: 700;
            color: #1a1a1a;
        }

        .receipt-created-by {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            color: #999;
            font-size: 0.85em;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .print-button, .close-button, .email-button {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .print-button {
            background: #D4AF37;
            color: #1a1a1a;
            border: none;
        }

        .print-button:hover {
            background: #B8941E;
        }

        .email-button {
            background: #4CAF50;
            color: #ffffff;
            border: none;
        }

        .email-button:hover {
            background: #43A047;
        }

        .close-button {
            background: transparent;
            border: 2px solid #1a1a1a;
            color: #1a1a1a;
        }

        .close-button:hover {
            background: #1a1a1a;
            color: white;
        }

        /* USER MANAGEMENT TABLE */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            background: var(--dark);
            color: var(--gold);
            font-weight: 600;
        }

        .users-table tr:hover {
            background: var(--dark);
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .user-status {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .user-active {
            background: #4CAF50;
            color: white;
        }

        .user-inactive {
            background: #f44336;
            color: white;
        }

        /* PRINT STYLES (RECIBO A4) */
        @media print {
            body {
                background: #ffffff;
                padding: 0;
                margin: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body * {
                visibility: hidden;
            }

            #receiptModal,
            #receiptModal * {
                visibility: visible;
            }

            #receiptModal {
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
            }

            .modal {
                display: block !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
            }

            .receipt-container {
                box-shadow: none !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0 auto !important;
                padding: 10mm 12mm !important;
                font-size: 12px !important;
                page-break-inside: avoid;
            }

            .receipt-header,
            .receipt-info,
            .receipt-observations,
            .receipt-footer {
                page-break-inside: avoid;
            }

            /* Esconde bot√µes no modo impress√£o A4 */
            .modal-actions {
                display: none !important;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .header {
                flex-direction: column;
                gap: 20px;
            }

            .user-info {
                position: static;
                transform: none;
            }

            .tab-buttons {
                overflow-x: auto;
            }

            .receipt-header {
                flex-direction: column;
            }

            .receipt-logo {
                margin: 20px 0 0 0;
            }

            .receipt-footer {
                grid-template-columns: 1fr;
            }
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <h1>JAMP Pratas</h1>
                <p>Sistema de Recibos</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">E-mail</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="login-button" id="loginButton">Entrar</button>
            </form>
        </div>
    </div>

    <!-- MAIN SYSTEM -->
    <div class="container" id="mainSystem">
        <div class="header">
            <h1>Sistema de Recibos</h1>
            <div class="user-info">
                <div class="user-badge">
                    <strong id="userName">Usu√°rio</strong>
                    <span id="userRole" class="admin-badge" style="display: none;">Admin</span>
                </div>
                <button class="logout-button" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- TABS -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('pedidos', event)">Pedidos</button>
            <button class="tab-button" id="usersTab" onclick="switchTab('usuarios', event)" style="display: none;">Usu√°rios</button>
        </div>

        <!-- TAB PEDIDOS -->
        <div class="tab-content active" id="tab-pedidos">
            <div class="main-content">
                <div class="card">
                    <h2 id="form-title">Novo Pedido</h2>
                    <form id="orderForm">
                        <div class="form-group">
                            <label for="clientName">Cliente *</label>
                            <input type="text" id="clientName" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefone *</label>
                            <input type="text" id="phone" required placeholder="(00) 00000-0000" maxlength="15">
                        </div>

                        <div class="form-group">
                            <label for="description">Descri√ß√£o *</label>
                            <textarea id="description" required placeholder="Descreva o modelo/pedido"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="ringSize">Numera√ß√£o do Anel (se aplic√°vel)</label>
                            <input type="text" id="ringSize" placeholder="Ex: 18">
                        </div>

                        <div class="form-group">
                            <label for="engraving">Conte√∫do da Grava√ß√£o</label>
                            <input type="text" id="engraving" placeholder="Texto para grava√ß√£o">
                        </div>

                        <div class="form-group">
                            <label for="value">Valor (R$) *</label>
                            <input type="text" id="value" required placeholder="0,00">
                        </div>

                        <div class="form-group">
                            <label for="deliveryDate">Prazo de Entrega *</label>
                            <input type="date" id="deliveryDate" required>
                        </div>

                        <div class="form-group">
                            <label>Status do Pagamento *</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="paymentStatus" value="pago" required>
                                    Pago
                                </label>
                                <label>
                                    <input type="radio" name="paymentStatus" value="50%" required>
                                    50%
                                </label>
                                <label>
                                    <input type="radio" name="paymentStatus" value="pendente" checked required>
                                    Pendente
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="paymentMethod">Forma de Pagamento</label>
                            <select id="paymentMethod">
                                <option value="">Selecione...</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                                <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="downPayment">Valor da Entrada (R$)</label>
                            <input type="text" id="downPayment" placeholder="0,00">
                        </div>

                        <div class="form-group">
                            <label for="observations">Observa√ß√µes Adicionais</label>
                            <textarea id="observations" placeholder="Informa√ß√µes extras sobre o pedido"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="button" id="submitBtn">Salvar Pedido</button>
                            <button type="button" class="button button-secondary" id="clearForm">Limpar</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>Pedidos Cadastrados</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Buscar por nome do cliente...">
                    </div>
                    <div class="orders-list" id="ordersList">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Nenhum pedido cadastrado ainda</p>
                        </div>
                    </div>
                    <div class="sync-status" id="syncStatus">Conectando...</div>
                </div>
            </div>
        </div>

        <!-- TAB USU√ÅRIOS (ADMIN ONLY) -->
        <div class="tab-content" id="tab-usuarios">
            <div class="card">
                <h2>Criar Novo Usu√°rio</h2>
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUserName">Nome *</label>
                        <input type="text" id="newUserName" required>
                    </div>

                    <div class="form-group">
                        <label for="newUserEmail">E-mail *</label>
                        <input type="email" id="newUserEmail" required>
                    </div>

                    <div class="form-group">
                        <label for="newUserPassword">Senha do Novo Usu√°rio *</label>
                        <input type="password" id="newUserPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres">
                    </div>

                    <div class="form-group">
                        <label>Tipo de Usu√°rio *</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="userRole" value="admin" required>
                                Administrador
                            </label>
                            <label>
                                <input type="radio" name="userRole" value="user" checked required>
                                Usu√°rio
                            </label>
                        </div>
                    </div>

                    <div class="form-group" style="border-top: 2px solid var(--border); padding-top: 20px; margin-top: 20px;">
                        <label for="adminPassword">Sua Senha (Admin) *</label>
                        <input type="password" id="adminPassword" required placeholder="Digite sua senha para confirmar">
                        <small style="color: #999; font-size: 0.85em; display: block; margin-top: 5px;">
                            Para seguran√ßa, confirme sua senha antes de criar o usu√°rio.
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="button" id="createUserBtn">Criar Usu√°rio</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="margin-bottom: 0;">Usu√°rios do Sistema</h2>
                    <button class="button btn-small" onclick="loadUsers()" style="background: var(--gold); color: var(--dark);">
                        üîÑ Recarregar
                    </button>
                </div>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                Carregando usu√°rios...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Recibo -->
    <div class="modal" id="receiptModal">
        <div class="receipt-container" id="receiptContent">
            <div class="receipt-header">
                <img src="logo-jamp.webp" alt="JAMP Pratas" class="receipt-logo" style="background:#000; color:#fff;">
                <div class="receipt-number" id="receipt-number">PEDIDO #<span id="receipt-order-number"></span></div>
                <div class="receipt-date" id="receipt-datetime"></div>
            </div>

            <div class="receipt-info">
                <h3 class="receipt-section-title">Informa√ß√µes do Cliente</h3>
                <div class="receipt-row">
                    <div class="receipt-label">Cliente:</div>
                    <div class="receipt-value" id="receipt-client"></div>
                </div>
                <div class="receipt-row">
                    <div class="receipt-label">Telefone:</div>
                    <div class="receipt-value" id="receipt-phone"></div>
                </div>
                <div class="receipt-row">
                    <div class="receipt-label">Descri√ß√£o:</div>
                    <div class="receipt-value" id="receipt-description"></div>
                </div>
                <div class="receipt-row" id="receipt-ring-row" style="display: none;">
                    <div class="receipt-label">Numera√ß√£o:</div>
                    <div class="receipt-value" id="receipt-ring"></div>
                </div>
                <div class="receipt-row" id="receipt-engraving-row" style="display: none;">
                    <div class="receipt-label">Grava√ß√£o:</div>
                    <div class="receipt-value" id="receipt-engraving"></div>
                </div>
            </div>

            <div class="receipt-observations">
                <h3>Observa√ß√µes Adicionais</h3>
                <div class="receipt-observations-content" id="receipt-observations-content"></div>
            </div>

            <div class="receipt-footer">
                <div class="receipt-payment">
                    <h4>Pagamento</h4>
                    <div class="receipt-payment-item">
                        <strong>Forma de Pagamento:</strong>
                        <p id="receipt-payment-method"></p>
                    </div>
                    <div class="receipt-payment-item">
                        <strong>Entrada:</strong>
                        <p id="receipt-down-payment"></p>
                    </div>
                    <div class="receipt-payment-item">
                        <strong>Valor Pendente:</strong>
                        <p id="receipt-pending"></p>
                    </div>
                </div>

                <div class="receipt-total">
                    <h4>VALOR TOTAL</h4>
                    <h2 id="receipt-total"></h2>
                </div>

                <div class="receipt-delivery">
                    <div class="receipt-delivery-label">Prazo de Entrega</div>
                    <h3 id="receipt-delivery-date"></h3>
                </div>
            </div>

            <div class="receipt-created-by">
                <p>Pedido criado por: <strong id="receipt-created-by-name"></strong></p>
            </div>

            <div class="modal-actions">
                <button class="email-button" onclick="openEmailModal()">üìß Enviar por Email</button>
                <button class="print-button" onclick="printReceipt()">Imprimir Recibo A4</button>
                <button class="print-button" onclick="printThermalReceipt()">Imprimir Recibo T√©rmico</button>
                <button class="close-button" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL ENVIO DE EMAIL -->
    <div class="modal" id="emailModal">
        <div class="receipt-container" style="max-width: 600px; padding: 30px;">
            <h2 style="margin-bottom: 20px;">üìß Enviar Recibo por Email</h2>

            <form id="emailForm" onsubmit="sendReceiptEmail(event)">
                <div class="form-group">
                    <label for="recipientEmail">Email do Destinat√°rio *</label>
                    <input type="email" id="recipientEmail" required placeholder="cliente@exemplo.com">
                    <small style="color: #999; font-size: 0.85em; display: block; margin-top: 5px;">
                        Para enviar para m√∫ltiplos emails, separe por v√≠rgula.
                    </small>
                </div>

                <div class="form-group">
                    <label for="emailSubject">Assunto do Email</label>
                    <input type="text" id="emailSubject" value="Recibo de Pedido - JAMP Pratas" required>
                </div>

                <div class="form-group">
                    <label for="emailMessage">Mensagem Adicional (Opcional)</label>
                    <textarea id="emailMessage" rows="4" placeholder="Ex: Ol√°! Segue em anexo o recibo do seu pedido..."></textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sendCopy" checked>
                        <span>Enviar uma c√≥pia para mim</span>
                    </label>
                </div>

                <div id="emailStatus" style="margin: 15px 0; padding: 10px; border-radius: 4px; display: none;"></div>

                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="button button-secondary btn-small" onclick="closeEmailModal()">Cancelar</button>
                    <button type="submit" class="button btn-small" id="sendEmailBtn">
                        <span id="sendEmailText">üìß Enviar Email</span>
                        <span id="sendEmailLoading" style="display: none;">‚è≥ Enviando...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RECIBO T√âRMICO (IMPRESSORA) -->
    <div id="thermal-receipt" style="display:none;">
        <div style="font-family: monospace; font-size: 12px; width: 58mm; max-width: 58mm;">
            <div style="text-align:center;">
                <strong>JAMP PRATAS</strong><br>
                ------------------------------<br>
                <strong>RECIBO PEDIDO #<span id="t-order-id"></span></strong><br>
                <span id="t-date"></span><br>
                ------------------------------<br>
            </div>

            Cliente: <span id="t-client"></span><br>
            Tel: <span id="t-phone"></span><br>
            ------------------------------<br>

            Pedido:<br>
            <span id="t-description"></span><br>

            <span id="t-ring" style="display:none;">
                Numera√ß√£o: <span id="t-ring-size"></span><br>
            </span>

            <span id="t-engraving" style="display:none;">
                Grava√ß√£o: <span id="t-engraving-text"></span><br>
            </span>

            ------------------------------<br>

            Valor Total: R$ <span id="t-value"></span><br>
            Entrada: R$ <span id="t-down"></span><br>
            Restante: R$ <span id="t-pending"></span><br>

            ------------------------------<br>

            Entrega: <span id="t-delivery"></span><br>
            Vendedor: <span id="t-user"></span><br>

            ------------------------------<br>
            <div style="text-align:center;">
                <span id="t-footer"></span><br>
            </div>
            ------------------------------<br>
            <div style="text-align:center;">
                Obrigado pela prefer√™ncia!
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- EMAILJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
    // Inicializa o EmailJS quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        try {
            console.log('üì¨ Inicializando EmailJS...');
            emailjs.init('wWdXZSM_6VvgHDyZj'); // PUBLIC KEY
            console.log('‚úÖ EmailJS inicializado');
        } catch (e) {
            console.error('‚ùå Erro ao inicializar EmailJS:', e);
        }
    });
    </script>

    <script>
    // CONFIGURA√á√ÉO DO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBJvZF2jPAfXpiwd2yKvBoe2xRjyQcO0wU",
        authDomain: "jamp-pratas-bfa64.firebaseapp.com",
        projectId: "jamp-pratas-bfa64",
        storageBucket: "jamp-pratas-bfa64.firebasestorage.app",
        messagingSenderId: "486145329966",
        appId: "1:486145329966:web:e10074144bddcde3fe88bf"
    };

    // CONFIG EMAILJS
    const EMAILJS_SERVICE_ID = 'service_x7obp1b';
    const EMAILJS_TEMPLATE_ID = 'template_38krot4';

    // Limites de seguran√ßa para evitar abusos / erros de tamanho
    const MAX_TEXT_LENGTH = 4000;   // texto livre (observa√ß√µes / mensagem e-mail)
    const MAX_EMAIL_SUBJECT = 120;  // assunto do e-mail
    const MAX_ORDER_VALUE = 999999.99;

    // Inicializar Firebase
    let db;
    let auth;
    let currentUser = null;
    let currentReceiptOrder = null;

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        console.log('Firebase inicializado com sucesso!');
    } catch (error) {
        console.error('Erro ao inicializar Firebase:', error);
        alert('Erro ao conectar com o banco de dados. Verifique as configura√ß√µes do Firebase.');
    }

    let orders = [];
    let editingOrderId = null;
    let unsubscribe = null;
    let users = [];
    let isLoadingUsers = false;

    // ===== Helpers de seguran√ßa =====
    function requireAuth() {
        if (!currentUser || !auth.currentUser) {
            showError('Sua sess√£o expirou. Fa√ßa login novamente.');
            showLoginScreen();
            throw new Error('UNAUTHENTICATED');
        }
    }

    function isAdmin() {
        return currentUser && currentUser.role === 'admin';
    }

    // AUTENTICA√á√ÉO
    auth.onAuthStateChanged(async (user) => {
        console.log('=== AUTH STATE CHANGED ===');
        console.log('User:', user ? user.email : 'null');

        if (user) {
            const userData = await getUserData(user.uid);
            if (userData && userData.active !== false) {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    name: userData.name,
                    role: userData.role
                };
                showMainSystem();
                loadOrders();
                if (userData.role === 'admin') {
                    showAdminFeatures();
                    const usersTab = document.getElementById('tab-usuarios');
                    if (usersTab && usersTab.classList.contains('active')) {
                        loadUsers();
                    }
                }
            } else {
                // Usu√°rio sem dados ou desativado
                showError('Seu usu√°rio est√° inativo ou n√£o configurado. Fale com o administrador.');
                currentUser = null;
                auth.signOut();
                showLoginScreen();
            }
        } else {
            // Limpa tudo na sa√≠da
            currentUser = null;
            orders = [];
            users = [];
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            showLoginScreen();
        }
    });

    async function getUserData(uid) {
        try {
            const doc = await db.collection('users').doc(uid).get();
            if (doc.exists) return doc.data();
            return null;
        } catch (error) {
            console.error('Erro ao buscar dados do usu√°rio:', error);
            return null;
        }
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const loginBtn = document.getElementById('loginButton');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Entrando...';

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            console.error('Erro ao fazer login:', error);
            let errorMessage = 'Erro ao fazer login. Verifique suas credenciais.';
            if (error.code === 'auth/user-not-found') errorMessage = 'Usu√°rio n√£o encontrado.';
            else if (error.code === 'auth/wrong-password') errorMessage = 'Senha incorreta.';
            else if (error.code === 'auth/invalid-email') errorMessage = 'E-mail inv√°lido.';
            showError(errorMessage);
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';
        }
    });

    function logout() {
        if (confirm('Tem certeza que deseja sair?')) {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            orders = [];
            users = [];
            currentUser = null;
            updateSyncStatus('Fa√ßa login para ver os pedidos');
            auth.signOut().catch(() => {});
            showLoginScreen();
        }
    }

    function showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainSystem').classList.remove('active');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginButton');
        if (loginForm) loginForm.reset();
        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';
        }
    }

    function showMainSystem() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainSystem').classList.add('active');
        document.getElementById('userName').textContent = currentUser.name;

        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector('.tab-button[onclick*="pedidos"]').classList.add('active');
        document.getElementById('tab-pedidos').classList.add('active');

        const usersTabButton = document.getElementById('usersTab');
        const usersTabContent = document.getElementById('tab-usuarios');
        if (usersTabButton) usersTabButton.style.display = 'none';
        if (usersTabContent) usersTabContent.classList.remove('active');
    }

    function showAdminFeatures() {
        document.getElementById('userRole').style.display = 'inline';
        const usersTabButton = document.getElementById('usersTab');
        const usersTabContent = document.getElementById('tab-usuarios');

        // Mostra apenas o bot√£o da aba "Usu√°rios"
        if (usersTabButton) usersTabButton.style.display = 'block';

        // N√£o for√ßa o conte√∫do a aparecer; continua escondido at√© ganhar .active
        if (usersTabContent) usersTabContent.classList.remove('active');
    }

    function switchTab(tabName, event) {
        if (tabName === 'usuarios') {
            if (!currentUser || !isAdmin()) {
                showError('Apenas administradores podem acessar essa aba.');
                return;
            }
        }
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        if (event && event.target) event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
        if (tabName === 'usuarios' && isAdmin()) {
            loadUsers();
        }
    }

    // CRIAR USU√ÅRIO
    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            requireAuth();
        } catch {
            return;
        }

        if (!isAdmin()) {
            showError('Apenas administradores podem criar usu√°rios.');
            return;
        }

        const name = document.getElementById('newUserName').value.trim();
        const email = document.getElementById('newUserEmail').value.trim();
        const password = document.getElementById('newUserPassword').value;
        const role = document.querySelector('input[name="userRole"]:checked').value;
        const adminPassword = document.getElementById('adminPassword').value;
        const createBtn = document.getElementById('createUserBtn');

        if (!name || !email || !password) {
            showError('Preencha todos os campos obrigat√≥rios.');
            return;
        }

        const adminEmail = currentUser.email;
        const adminUid = currentUser.uid;

        createBtn.disabled = true;
        createBtn.textContent = 'Criando...';

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(adminEmail, adminPassword);
            await auth.currentUser.reauthenticateWithCredential(credential);

            const secondaryApp = firebase.initializeApp(firebaseConfig, "SecondaryApp");
            const secondaryAuth = secondaryApp.auth();
            const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
            const newUserId = userCredential.user.uid;

            await db.collection('users').doc(newUserId).set({
                name,
                email,
                role,
                active: true,
                createdAt: Date.now(),
                createdBy: adminUid
            });

            await secondaryAuth.signOut();
            await secondaryApp.delete();

            showNotification('Usu√°rio criado com sucesso!');
            document.getElementById('createUserForm').reset();
            await loadUsers();
        } catch (error) {
            console.error('Erro na cria√ß√£o de usu√°rio:', error);
            let errorMessage = 'Erro ao criar usu√°rio.';
            if (error.code === 'auth/email-already-in-use') errorMessage = 'Este e-mail j√° est√° em uso.';
            else if (error.code === 'auth/weak-password') errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
            else if (error.code === 'auth/wrong-password') errorMessage = 'Senha do administrador incorreta!';
            else if (error.code === 'auth/network-request-failed') errorMessage = 'Erro de conex√£o. Verifique sua internet.';
            showError(errorMessage);
        } finally {
            createBtn.disabled = false;
            createBtn.textContent = 'Criar Usu√°rio';
        }
    });

    async function loadUsers() {
        try {
            requireAuth();
        } catch {
            return;
        }

        if (!isAdmin()) {
            showError('Apenas administradores podem visualizar usu√°rios.');
            return;
        }

        if (isLoadingUsers) return;
        isLoadingUsers = true;
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                    üîÑ Carregando usu√°rios...
                </td>
            </tr>
        `;
        try {
            const snapshot = await db.collection('users').get();
            users = [];
            snapshot.forEach(doc => {
                users.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            renderUsers();
        } catch (error) {
            console.error('Erro ao carregar usu√°rios:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #f44336;">
                        ‚ùå Erro ao carregar usu√°rios<br>
                        <small style="color: #999; margin-top: 10px; display: block;">
                            ${error.message || 'Verifique as regras do Firestore'}
                        </small>
                        <button class="button btn-small" onclick="loadUsers()" style="background: var(--gold); color: var(--dark); margin-top: 15px;">
                            Tentar Novamente
                        </button>
                    </td>
                </tr>
            `;
            showError('Erro ao carregar usu√°rios. Verifique o console (F12) para mais detalhes.');
        } finally {
            isLoadingUsers = false;
        }
    }

    function renderUsers() {
        const tbody = document.getElementById('usersTableBody');
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px;">
                        <div style="color: #999; margin-bottom: 15px;">
                            üìã Nenhum usu√°rio cadastrado ainda
                        </div>
                        <button class="button btn-small" onclick="loadUsers()" style="background: var(--gold); color: var(--dark);">
                            Recarregar Lista
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.name || 'N/A'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.role === 'admin' ? 'Administrador' : 'Usu√°rio'}</td>
                <td>
                    <span class="user-status ${user.active ? 'user-active' : 'user-inactive'}">
                        ${user.active ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>
                    <div class="user-actions">
                        ${user.id !== (currentUser && currentUser.uid) ? `
                            <button class="button btn-small" onclick="toggleUserStatus('${user.id}', ${!user.active})">
                                ${user.active ? 'Desativar' : 'Ativar'}
                            </button>
                        ` : '<span style="color: var(--gold);">Voc√™</span>'}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function toggleUserStatus(userId, newStatus) {
        try {
            requireAuth();
        } catch {
            return;
        }

        if (!isAdmin()) {
            showError('Apenas administradores podem gerenciar usu√°rios.');
            return;
        }
        if (userId === currentUser.uid) {
            showError('Voc√™ n√£o pode alterar o pr√≥prio status.');
            return;
        }
        try {
            await db.collection('users').doc(userId).update({ active: newStatus });
            showNotification(`Usu√°rio ${newStatus ? 'ativado' : 'desativado'} com sucesso!`);
            loadUsers();
        } catch (error) {
            console.error('Erro ao atualizar usu√°rio:', error);
            showError('Erro ao atualizar usu√°rio.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        setMinDeliveryDate();
        setupSearch();
    });

    function setMinDeliveryDate() {
        const today = new Date().toISOString().split('T')[0];
        const input = document.getElementById('deliveryDate');
        input.min = today;
        if (!input.value) input.value = today;
    }

    function phoneMask(value) {
        if (!value) return '';
        value = value.replace(/\D/g, '');
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        return value;
    }

    function currencyMask(value) {
        if (!value) return '';
        value = value.replace(/\D/g, '');
        value = value.replace(/(\d)(\d{2})$/, '$1,$2');
        value = value.replace(/(?=(\d{3})+(\D))\B/g, '.');
        return value;
    }

    function currencyToNumber(value) {
        if (!value) return 0;
        return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
    }

    function numberToCurrency(value) {
        if (!value && value !== 0) return '';
        return value.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+\,)/g, '$1.');
    }

    document.getElementById('phone').addEventListener('input', (e) => {
        e.target.value = phoneMask(e.target.value);
    });
    document.getElementById('value').addEventListener('input', (e) => {
        e.target.value = currencyMask(e.target.value);
    });
    document.getElementById('downPayment').addEventListener('input', (e) => {
        e.target.value = currencyMask(e.target.value);
    });

    function loadOrders() {
        try {
            requireAuth();
        } catch {
            return;
        }

        if (!db) {
            showError('Banco de dados n√£o inicializado');
            return;
        }
        if (unsubscribe) unsubscribe();

        unsubscribe = db.collection('orders')
            .orderBy('createdAt', 'desc')
            .onSnapshot((snapshot) => {
                orders = [];
                snapshot.forEach((doc) => {
                    const orderData = doc.data();
                    if (!orderData.createdAt) {
                        orderData.createdAt = Date.now();
                        db.collection('orders').doc(doc.id).update({ createdAt: orderData.createdAt }).catch(() => {});
                    }
                    orders.push({
                        id: doc.id,
                        ...orderData
                    });
                });

                // Privacidade b√°sica: se n√£o for admin, mostra s√≥ pedidos criados por ele
                const visibleOrders = isAdmin()
                    ? orders
                    : orders.filter(o => o.createdBy === currentUser.uid);

                renderOrdersUI(visibleOrders);
                updateSyncStatus('Sincronizado');
            }, (error) => {
                console.error('Erro ao carregar pedidos:', error);
                updateSyncStatus('Erro de sincroniza√ß√£o');
                showError('Erro ao carregar pedidos');
            });
    }

    function updateSyncStatus(status) {
        document.getElementById('syncStatus').textContent = status;
    }

    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            requireAuth();
        } catch {
            return;
        }

        const deliveryDate = document.getElementById('deliveryDate').value;
        const today = new Date().toISOString().split('T')[0];
        if (deliveryDate < today) {
            showError('A data de entrega n√£o pode ser anterior √† data atual!');
            return;
        }

        const valueNumber = currencyToNumber(document.getElementById('value').value);
        const downNumber = currencyToNumber(document.getElementById('downPayment').value);

        if (valueNumber <= 0 || valueNumber > MAX_ORDER_VALUE) {
            showError('Informe um valor v√°lido para o pedido.');
            return;
        }
        if (downNumber < 0) {
            showError('A entrada n√£o pode ser negativa.');
            return;
        }
        if (downNumber > valueNumber) {
            showError('A entrada n√£o pode ser maior que o valor total.');
            return;
        }

        const observations = document.getElementById('observations').value;
        if (observations && observations.length > MAX_TEXT_LENGTH) {
            showError(`Observa√ß√µes muito grandes. M√°ximo de ${MAX_TEXT_LENGTH} caracteres.`);
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Salvando...';

        const baseOrder = editingOrderId ? orders.find(o => o.id === editingOrderId) : null;

        const formData = {
            clientName: document.getElementById('clientName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            description: document.getElementById('description').value.trim(),
            ringSize: document.getElementById('ringSize').value.trim(),
            engraving: document.getElementById('engraving').value.trim(),
            value: valueNumber,
            deliveryDate: deliveryDate,
            paymentStatus: document.querySelector('input[name="paymentStatus"]:checked').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            downPayment: downNumber,
            observations: observations.trim(),
            createdAt: baseOrder ? baseOrder.createdAt : Date.now(),
            createdBy: baseOrder ? baseOrder.createdBy : currentUser.uid,
            createdByName: baseOrder ? baseOrder.createdByName : currentUser.name
        };

        try {
            if (editingOrderId) {
                await db.collection('orders').doc(editingOrderId).update(formData);
                showNotification('Pedido atualizado com sucesso!');
                editingOrderId = null;
                document.getElementById('form-title').textContent = 'Novo Pedido';
            } else {
                await db.collection('orders').add(formData);
                showNotification('Pedido salvo com sucesso!');
            }
            document.getElementById('orderForm').reset();
            setMinDeliveryDate();
        } catch (error) {
            console.error('Erro ao salvar pedido:', error);
            showError('Erro ao salvar pedido');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar Pedido';
        }
    });

    document.getElementById('clearForm').addEventListener('click', () => {
        document.getElementById('orderForm').reset();
        editingOrderId = null;
        document.getElementById('form-title').textContent = 'Novo Pedido';
        setMinDeliveryDate();
    });

    function renderOrdersUI(sourceOrders, searchTerm = '') {
        const ordersList = document.getElementById('ordersList');
        let filteredOrders = sourceOrders;

        if (searchTerm) {
            filteredOrders = sourceOrders.filter(order =>
                (order.clientName || '').toLowerCase().includes(searchTerm)
            );
        }

        if (filteredOrders.length === 0) {
            ordersList.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>${searchTerm ? 'Nenhum pedido encontrado' : 'Nenhum pedido cadastrado ainda'}</p>
                </div>
            `;
            return;
        }

        ordersList.innerHTML = filteredOrders.map(order => {
            const statusClass = order.paymentStatus === 'pago' ? 'status-pago' :
                              order.paymentStatus === '50%' ? 'status-metade' : 'status-pendente';
            const statusText = order.paymentStatus === 'pago' ? 'PAGO' :
                             order.paymentStatus === '50%' ? '50%' : 'PENDENTE';

            return `
                <div class="order-item">
                    <h3>${order.clientName} <span class="status-badge ${statusClass}">${statusText}</span></h3>
                    <p><strong>Telefone:</strong> ${order.phone}</p>
                    <p><strong>Descri√ß√£o:</strong> ${order.description}</p>
                    <p><strong>Valor:</strong> R$ ${numberToCurrency(order.value)}</p>
                    <p><strong>Entrega:</strong> ${formatDate(order.deliveryDate)}</p>
                    <p style="font-size: 0.85em; color: #999; margin-top: 10px;"><strong>Criado por:</strong> ${order.createdByName || 'N/A'}</p>
                    <div class="order-actions">
                        <button class="button btn-small" onclick="viewReceipt('${order.id}')">Ver Recibo</button>
                        <button class="button button-secondary btn-small" onclick="editOrder('${order.id}')">Editar</button>
                        <button class="button button-secondary btn-small" onclick="deleteOrder('${order.id}')">Excluir</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderOrders(searchTerm = '') {
        const visibleOrders = isAdmin()
            ? orders
            : orders.filter(o => o.createdBy === (currentUser && currentUser.uid));
        renderOrdersUI(visibleOrders, searchTerm);
    }

    async function editOrder(id) {
        try {
            requireAuth();
        } catch {
            return;
        }

        const order = orders.find(o => o.id === id);
        if (!order) return;

        // Usu√°rio comum s√≥ pode editar pedido pr√≥prio
        if (!isAdmin() && order.createdBy !== currentUser.uid) {
            showError('Voc√™ n√£o tem permiss√£o para editar este pedido.');
            return;
        }

        editingOrderId = id;
        document.getElementById('form-title').textContent = 'Editar Pedido';

        document.getElementById('clientName').value = order.clientName;
        document.getElementById('phone').value = phoneMask(order.phone);
        document.getElementById('description').value = order.description;
        document.getElementById('ringSize').value = order.ringSize || '';
        document.getElementById('engraving').value = order.engraving || '';
        document.getElementById('value').value = numberToCurrency(order.value);
        document.getElementById('deliveryDate').value = order.deliveryDate;
        document.querySelector(`input[name="paymentStatus"][value="${order.paymentStatus}"]`).checked = true;
        document.getElementById('paymentMethod').value = order.paymentMethod || '';
        document.getElementById('downPayment').value = order.downPayment ? numberToCurrency(order.downPayment) : '';
        document.getElementById('observations').value = order.observations || '';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteOrder(id) {
        try {
            requireAuth();
        } catch {
            return;
        }

        const order = orders.find(o => o.id === id);
        if (!order) return;

        // Usu√°rio comum s√≥ pode excluir pedido pr√≥prio
        if (!isAdmin() && order.createdBy !== currentUser.uid) {
            showError('Voc√™ n√£o tem permiss√£o para excluir este pedido.');
            return;
        }

        if (confirm('Tem certeza que deseja excluir este pedido?')) {
            try {
                await db.collection('orders').doc(id).delete();
                showNotification('Pedido exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                showError('Erro ao excluir pedido');
            }
        }
    }

    // Remove emojis e caracteres especiais para impress√£o t√©rmica
    function sanitizeText(text) {
        if (!text) return "";

        // Remove emojis
        text = text.replace(
            /([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF])+/g,
            ""
        );

        // Remove acentos
        text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        // Permite: letras/n√∫meros (\w), espa√ßo (\s), . , : / # @ ( ) - [ ]
        text = text.replace(/[^\w\s.,:/#@()\-\[\]]/g, "");

        return text.trim();
    }

    function generateThermalReceipt(order) {
        if (!order) return;

        document.getElementById("t-order-id").textContent = (order._id || "").toString().slice(-6);

        let createdDate;
        if (order.createdAt) {
            if (order.createdAt.toDate) createdDate = order.createdAt.toDate();
            else createdDate = new Date(order.createdAt);
        } else {
            createdDate = new Date();
        }
        const formattedDateTime = createdDate.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        }) + ' ' + createdDate.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById("t-date").textContent = formattedDateTime;

        document.getElementById("t-client").textContent = sanitizeText(order.clientName);
        document.getElementById("t-phone").textContent = sanitizeText(order.phone);
        document.getElementById("t-description").textContent = sanitizeText(order.description);

        if (order.ringSize) {
            document.getElementById("t-ring").style.display = "inline";
            document.getElementById("t-ring-size").textContent = sanitizeText(order.ringSize);
        } else {
            document.getElementById("t-ring").style.display = "none";
        }

        if (order.engraving) {
            document.getElementById("t-engraving").style.display = "inline";
            document.getElementById("t-engraving-text").textContent = sanitizeText(order.engraving);
        } else {
            document.getElementById("t-engraving").style.display = "none";
        }

        const total = order.value || 0;
        const down = order.downPayment || 0;
        const pending = total - down;

        document.getElementById("t-value").textContent = numberToCurrency(total);
        document.getElementById("t-down").textContent = numberToCurrency(down);
        document.getElementById("t-pending").textContent = numberToCurrency(pending);

        document.getElementById("t-delivery").textContent = formatDate(order.deliveryDate);
        document.getElementById("t-user").textContent = sanitizeText(order.createdByName || "");

        document.getElementById("t-footer").textContent = sanitizeText("Siga @jamppratas üíé");
    }

    function printThermalReceipt() {
        try {
            requireAuth();
        } catch {
            return;
        }

        if (!currentReceiptOrder) {
            showError("Abra um recibo antes de imprimir na impressora t√©rmica.");
            return;
        }
        generateThermalReceipt(currentReceiptOrder);

        const thermalDiv = document.getElementById("thermal-receipt");
        if (!thermalDiv) {
            showError("Modelo de recibo t√©rmico n√£o encontrado.");
            return;
        }

        const printWindow = window.open("", "_blank", "width=400,height=600");
        const html = `
            <html>
            <head>
                <title>Recibo T√©rmico - JAMP Pratas</title>
                <style>
                    @page { margin: 2mm; }
                    body {
                        font-family: monospace;
                        font-size: 12px;
                        width: 58mm;
                        max-width: 58mm;
                        margin: 0;
                        padding: 0;
                    }
                </style>
            </head>
            <body>
                ${thermalDiv.innerHTML}
                <script>
                    window.onload = function() {
                        window.print();
                        window.onfocus = function() { window.close(); };
                    };
                <\/script>
            </body>
            </html>
        `;
        printWindow.document.open();
        printWindow.document.write(html);
        printWindow.document.close();
    }

    // Visualizar recibo A4
    function viewReceipt(id) {
        try {
            requireAuth();
        } catch {
            return;
        }

        const order = orders.find(o => o.id === id);
        if (!order) return;

        // Usu√°rio comum s√≥ pode ver pedidos pr√≥prios
        if (!isAdmin() && order.createdBy !== currentUser.uid) {
            showError('Voc√™ n√£o tem permiss√£o para visualizar este pedido.');
            return;
        }

        currentReceiptOrder = { ...order, _id: id };

        document.getElementById('receipt-order-number').textContent = id.toString().slice(-6);

        let createdDate;
        if (order.createdAt) {
            if (order.createdAt.toDate) createdDate = order.createdAt.toDate();
            else createdDate = new Date(order.createdAt);
        } else {
            createdDate = new Date();
        }
        const formattedDateTime = createdDate.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        }) + ' √†s ' + createdDate.toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('receipt-datetime').textContent = formattedDateTime;

        document.getElementById('receipt-client').textContent = order.clientName;
        document.getElementById('receipt-phone').textContent = order.phone;
        document.getElementById('receipt-description').textContent = order.description;

        const ringRow = document.getElementById('receipt-ring-row');
        if (order.ringSize) {
            document.getElementById('receipt-ring').textContent = order.ringSize;
            ringRow.style.display = 'flex';
        } else {
            ringRow.style.display = 'none';
        }

        const engravingRow = document.getElementById('receipt-engraving-row');
        if (order.engraving) {
            document.getElementById('receipt-engraving').textContent = order.engraving;
            engravingRow.style.display = 'flex';
        } else {
            engravingRow.style.display = 'none';
        }

        document.getElementById('receipt-observations-content').textContent =
            order.observations || 'Nenhuma observa√ß√£o adicional.';

        const paymentStatusText = order.paymentStatus === 'pago' ? 'PAGO' :
                                 order.paymentStatus === '50%' ? '50% PAGO' : 'PENDENTE';
        const paymentMethodText = order.paymentMethod || 'N√£o informado';

        document.getElementById('receipt-payment-method').textContent = `${paymentMethodText} - ${paymentStatusText}`;
        document.getElementById('receipt-down-payment').textContent = order.downPayment > 0 ?
            `R$ ${numberToCurrency(order.downPayment)}` : 'R$ 0,00';

        const pendingValue = order.value - order.downPayment;
        document.getElementById('receipt-pending').textContent = `R$ ${numberToCurrency(pendingValue)}`;

        document.getElementById('receipt-total').textContent = `R$ ${numberToCurrency(order.value)}`;
        document.getElementById('receipt-delivery-date').textContent = formatDate(order.deliveryDate);
        document.getElementById('receipt-created-by-name').textContent = order.createdByName || 'N/A';

        // j√° prepara o recibo t√©rmico
        generateThermalReceipt(currentReceiptOrder);

        document.getElementById('receiptModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('receiptModal').classList.remove('active');
    }

    function openEmailModal() {
        try {
            requireAuth();
        } catch {
            return;
        }

        const receiptModal = document.getElementById('receiptModal');
        if (!receiptModal.classList.contains('active')) {
            showError('Abra um recibo antes de enviar por email.');
            return;
        }
        document.getElementById('emailModal').classList.add('active');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.remove('active');
        const form = document.getElementById('emailForm');
        if (form) form.reset();
        const statusDiv = document.getElementById('emailStatus');
        if (statusDiv) {
            statusDiv.style.display = 'none';
            statusDiv.innerHTML = '';
        }
    }

    function buildReceiptHtmlForEmail(customMessage = '') {
        const original = document.getElementById('receiptContent');
        if (!original) return '';
        const receiptNode = original.cloneNode(true);
        const actions = receiptNode.querySelector('.modal-actions');
        if (actions) actions.remove();

        if (customMessage && customMessage.trim()) {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = customMessage;
            msgDiv.style.marginBottom = '20px';
            msgDiv.style.padding = '10px';
            msgDiv.style.border = '1px solid #eee';
            msgDiv.style.background = '#fafafa';
            receiptNode.insertBefore(msgDiv, receiptNode.firstChild);
        }

        const receiptHtml = receiptNode.innerHTML;

        return `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <title>Recibo - JAMP Pratas</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #ffffff;
                color: #1a1a1a;
                margin: 0;
                padding: 0;
            }
            .receipt-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 16px;
            }
            .receipt-logo {
                background: #000000 !important;
            }
        </style>
    </head>
    <body>
        <div class="receipt-container">
            ${receiptHtml}
        </div>
    </body>
    </html>
        `;
    }

    async function sendReceiptEmail(event) {
        if (event && event.preventDefault) event.preventDefault();

        try {
            requireAuth();
        } catch {
            return;
        }

        try {
            if (!window.emailjs) {
                throw new Error('EmailJS n√£o est√° carregado.');
            }

            const recipientEmail = document.getElementById('recipientEmail').value.trim();
            let subject = document.getElementById('emailSubject').value.trim();
            let extraMessage = document.getElementById('emailMessage').value.trim();
            const sendCopy = document.getElementById('sendCopy').checked;

            if (!recipientEmail) {
                showError('Informe o e-mail do destinat√°rio.');
                return;
            }

            if (subject.length > MAX_EMAIL_SUBJECT) {
                subject = subject.substring(0, MAX_EMAIL_SUBJECT);
            }

            if (extraMessage.length > MAX_TEXT_LENGTH) {
                extraMessage = extraMessage.substring(0, MAX_TEXT_LENGTH);
            }

            const receiptHtml = buildReceiptHtmlForEmail(extraMessage);

            const templateParams = {
                to_email: recipientEmail,
                subject: subject,
                extra_message: extraMessage,
                receipt_html: receiptHtml,
                send_copy: sendCopy ? 'sim' : 'nao',
            };

            const sendBtn = document.getElementById('sendEmailBtn');
            const sendText = document.getElementById('sendEmailText');
            const sendLoading = document.getElementById('sendEmailLoading');

            sendBtn.disabled = true;
            if (sendText) sendText.style.display = 'none';
            if (sendLoading) sendLoading.style.display = 'inline';

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

            showNotification('Recibo enviado por e-mail com sucesso!');
            closeEmailModal();
        } catch (error) {
            console.error('Erro ao enviar email:', error);
            showError('Erro ao enviar o e-mail.');
        } finally {
            const sendBtn = document.getElementById('sendEmailBtn');
            const sendText = document.getElementById('sendEmailText');
            const sendLoading = document.getElementById('sendEmailLoading');
            if (sendBtn) sendBtn.disabled = false;
            if (sendText) sendText.style.display = 'inline';
            if (sendLoading) sendLoading.style.display = 'none';
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            renderOrders(searchTerm);
        });
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function showError(message) {
        const notification = document.createElement('div');
        notification.className = 'notification error';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }

    function printReceipt() {
        try {
            requireAuth();
        } catch {
            return;
        }
        window.print();
    }
</script>

</body>
</html>

